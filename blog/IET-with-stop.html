<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interval Exchange Transformation Iterator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #ddd6fe 100%);
            min-height: 100vh;
            padding: 2rem;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        h1 {
            color: #312e81;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .subtitle {
            color: #6b7280;
            margin-bottom: 1.5rem;
        }
        
        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        h2 {
            color: #1f2937;
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }
        
        .interval-row {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            align-items: center;
        }
        
        input, select {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 1rem;
        }
        
        input[type="text"]:disabled {
            background: #f3f4f6;
            font-family: monospace;
            width: 4rem;
        }
        
        .flex-1 {
            flex: 1;
        }
        
        button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
        }
        
        .btn-primary {
            background: #4f46e5;
            color: white;
            width: 100%;
            padding: 0.75rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .btn-primary:hover {
            background: #4338ca;
        }
        
        .btn-add {
            background: #4f46e5;
            color: white;
            margin-top: 0.5rem;
        }
        
        .btn-add:hover {
            background: #4338ca;
        }
        
        .btn-remove {
            background: #ef4444;
            color: white;
        }
        
        .btn-remove:hover {
            background: #dc2626;
        }
        
        .perm-container {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        .input-group {
            margin-bottom: 1rem;
        }
        
        .error {
            padding: 0.75rem;
            background: #fee2e2;
            border: 1px solid #fca5a5;
            color: #991b1b;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }
        
        .success {
            padding: 1rem;
            background: #d1fae5;
            border: 2px solid #10b981;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .success-title {
            color: #065f46;
            font-weight: bold;
            font-size: 1.125rem;
        }
        
        .success-subtitle {
            color: #047857;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        .info-box {
            padding: 1rem;
            background: #f9fafb;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }
        
        .info-box h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .mono {
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
        
        .highlighted {
            background: #fef3c7;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }
        
        .iterates-box {
            padding: 1rem;
            background: #eef2ff;
            border-radius: 0.375rem;
        }
        
        .iterates-list {
            max-height: 24rem;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
        
        .iterate-item {
            padding: 0.25rem 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Interval Exchange Transformation</h1>
        <p class="subtitle">Compute iterates of a point under an IET</p>

        <div class="card">
            <h2>Define Intervals</h2>
            <div id="intervals-container"></div>
            <button class="btn-add" onclick="addInterval()">Add Interval</button>

            <h2 style="margin-top: 1.5rem;">Define Permutation</h2>
            <div class="perm-container" id="permutation-container"></div>
        </div>

        <div class="card">
            <h2>Input</h2>
            
            <div class="input-group">
                <label>Initial Point (decimal or fraction, e.g., 1/4 or 0.25)</label>
                <input type="text" id="inputNumber" class="flex-1" value="0.25" placeholder="e.g., 0.25 or 1/4">
            </div>

            <div class="input-group">
                <label>Selected Interval (stop when hit)</label>
                <select id="selectedInterval" class="flex-1"></select>
            </div>

            <div class="input-group">
                <label>Maximum Number of Iterates</label>
                <input type="number" id="numIterates" class="flex-1" value="10" min="1" max="1000">
            </div>

            <div id="error-container"></div>

            <button class="btn-primary" onclick="computeIET()">
                <span>▶</span> Compute Iterates
            </button>
        </div>

        <div id="results-container"></div>
    </div>

    <script>
        let intervals = [
            { label: 'A', length: '0.5' },
            { label: 'B', length: '0.3' },
            { label: 'C', length: '0.2' }
        ];
        let permutation = ['B', 'C', 'A'];
        let selectedInterval = 'B';

        function renderIntervals() {
            const container = document.getElementById('intervals-container');
            container.innerHTML = intervals.map((int, idx) => `
                <div class="interval-row">
                    <input type="text" value="${int.label}" disabled>
                    <input type="text" class="flex-1" value="${int.length}" 
                           onchange="updateIntervalLength(${idx}, this.value)">
                    ${intervals.length > 2 ? 
                        `<button class="btn-remove" onclick="removeInterval(${idx})">Remove</button>` : 
                        ''}
                </div>
            `).join('');
        }

        function renderPermutation() {
            const container = document.getElementById('permutation-container');
            container.innerHTML = permutation.map((label, idx) => `
                <select onchange="updatePermutation(${idx}, this.value)">
                    ${intervals.map(int => 
                        `<option value="${int.label}" ${int.label === label ? 'selected' : ''}>${int.label}</option>`
                    ).join('')}
                </select>
            `).join('');
        }

        function renderSelectedInterval() {
            const select = document.getElementById('selectedInterval');
            select.innerHTML = intervals.map(int => 
                `<option value="${int.label}" ${int.label === selectedInterval ? 'selected' : ''}>
                    Interval ${int.label}
                </option>`
            ).join('');
        }

        function addInterval() {
            const newLabel = String.fromCharCode(65 + intervals.length);
            intervals.push({ label: newLabel, length: '0.1' });
            permutation.push(newLabel);
            renderIntervals();
            renderPermutation();
            renderSelectedInterval();
        }

        function removeInterval(index) {
            if (intervals.length <= 2) return;
            const removed = intervals[index];
            intervals.splice(index, 1);
            permutation = permutation.filter(label => label !== removed.label);
            if (selectedInterval === removed.label) {
                selectedInterval = intervals[0].label;
            }
            renderIntervals();
            renderPermutation();
            renderSelectedInterval();
        }

        function updateIntervalLength(index, value) {
            intervals[index].length = value;
        }

        function updatePermutation(index, value) {
            permutation[index] = value;
        }

        function parseRational(str) {
            str = str.trim();
            if (str.includes('/')) {
                const [num, den] = str.split('/').map(s => parseFloat(s.trim()));
                if (den === 0) throw new Error('Denominator cannot be zero');
                return num / den;
            }
            return parseFloat(str);
        }

        function showError(message) {
            document.getElementById('error-container').innerHTML = 
                `<div class="error">${message}</div>`;
        }

        function clearError() {
            document.getElementById('error-container').innerHTML = '';
        }

        function computeIET() {
            clearError();
            selectedInterval = document.getElementById('selectedInterval').value;
            
            try {
                const x = parseRational(document.getElementById('inputNumber').value);
                const n = parseInt(document.getElementById('numIterates').value);
                
                if (isNaN(x) || x < 0 || x > 1) {
                    showError('Input must be a number between 0 and 1');
                    return;
                }
                
                if (isNaN(n) || n < 1 || n > 1000) {
                    showError('Number of iterates must be between 1 and 1000');
                    return;
                }

                const lengths = intervals.map(int => {
                    const len = parseFloat(int.length);
                    if (isNaN(len) || len <= 0) {
                        throw new Error(`Invalid length for interval ${int.label}`);
                    }
                    return { label: int.label, length: len };
                });

                const totalLength = lengths.reduce((sum, int) => sum + int.length, 0);
                if (Math.abs(totalLength - 1.0) > 0.0001) {
                    showError(`Interval lengths must sum to 1 (currently sum to ${totalLength.toFixed(4)})`);
                    return;
                }

                const labels = lengths.map(int => int.label);
                const permSet = new Set(permutation);
                if (permutation.length !== labels.length || !labels.every(l => permSet.has(l))) {
                    showError('Permutation must contain each interval label exactly once');
                    return;
                }

                const topIntervals = [];
                let cumSum = 0;
                for (const int of lengths) {
                    topIntervals.push({
                        label: int.label,
                        start: cumSum,
                        end: cumSum + int.length
                    });
                    cumSum += int.length;
                }

                const bottomIntervals = [];
                cumSum = 0;
                for (const label of permutation) {
                    const int = lengths.find(i => i.label === label);
                    bottomIntervals.push({
                        label: label,
                        start: cumSum,
                        end: cumSum + int.length
                    });
                    cumSum += int.length;
                }

                const iterates = [x];
                let current = x;
                let hitSelected = false;

                const selectedTopInt = topIntervals.find(int => int.label === selectedInterval);

                for (let i = 0; i < n; i++) {
                    const topInt = topIntervals.find(int => 
                        current >= int.start && current < int.end
                    );
                    
                    if (!topInt) {
                        if (Math.abs(current - 1.0) < 1e-10) {
                            const lastTop = topIntervals[topIntervals.length - 1];
                            const bottomInt = bottomIntervals.find(int => int.label === lastTop.label);
                            current = bottomInt.end;
                        } else {
                            showError(`Point ${current} is out of bounds`);
                            return;
                        }
                    } else {
                        const bottomInt = bottomIntervals.find(int => int.label === topInt.label);
                        const offsetInTop = current - topInt.start;
                        current = bottomInt.start + offsetInTop;
                    }
                    
                    iterates.push(current);

                    if (current >= selectedTopInt.start && current < selectedTopInt.end) {
                        hitSelected = true;
                        break;
                    }
                    
                    if (Math.abs(current - selectedTopInt.end) < 1e-10 && 
                        Math.abs(selectedTopInt.end - 1.0) < 1e-10) {
                        hitSelected = true;
                        break;
                    }
                }

                displayResults(iterates, topIntervals, bottomIntervals, hitSelected);

            } catch (err) {
                showError(err.message);
            }
        }

        function displayResults(iterates, topIntervals, bottomIntervals, hitSelected) {
            const container = document.getElementById('results-container');
            
            let html = '<div class="card"><h2>Results</h2>';
            
            if (hitSelected) {
                html += `
                    <div class="success">
                        <p class="success-title">✓ Hit selected interval ${selectedInterval}!</p>
                        <p class="success-subtitle">Stopped after ${iterates.length - 1} iterate(s)</p>
                    </div>
                `;
            }
            
            html += '<div class="info-box"><h3>Top Intervals:</h3><div class="mono">';
            for (const int of topIntervals) {
                const isSelected = int.label === selectedInterval;
                html += `<div ${isSelected ? 'class="highlighted"' : ''}>
                    ${int.label}: [${int.start.toFixed(6)}, ${int.end.toFixed(6)})
                    ${isSelected ? ' ← Selected' : ''}
                </div>`;
            }
            html += '</div></div>';
            
            html += '<div class="info-box"><h3>Bottom Intervals (after permutation):</h3><div class="mono">';
            for (const int of bottomIntervals) {
                html += `<div>${int.label}: [${int.start.toFixed(6)}, ${int.end.toFixed(6)})</div>`;
            }
            html += '</div></div>';
            
            html += '<div class="iterates-box"><h3>Iterates:</h3><div class="iterates-list">';
            for (let i = 0; i < iterates.length; i++) {
                html += `<div class="iterate-item">x_${i} = ${iterates[i].toFixed(10)}</div>`;
            }
            html += '</div></div>';
            
            html += '</div>';
            
            container.innerHTML = html;
        }

        // Initialize
        renderIntervals();
        renderPermutation();
        renderSelectedInterval();
    </script>
</body>
</html>
